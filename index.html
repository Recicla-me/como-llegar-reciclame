<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Cómo llegar - Recíclame Gestión Medioambiental</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 30px 15px;
      background-color: #f4f4f4;
    }
    h1 {
      margin-bottom: 10px;
    }
    p {
      margin: 5px 0;
    }
    .button {
      display: block;
      margin: 15px auto;
      padding: 15px 25px;
      font-size: 18px;
      text-decoration: none;
      border-radius: 8px;
      color: #ffffff;
      background-color: #7ED321; /* verde flúor */
      width: 80%;
      max-width: 320px;
      box-sizing: border-box;
    }
    .apple {
      background-color: #000000;
    }
  </style>
</head>

<body>
  <h1>¿Cómo llegar?</h1>
  <p>Recíclame Gestión Medioambiental</p>
  <p>C/ Seúl, 14, Humanes de Madrid, Madrid, 28970</p>

  <h1>HORARIO</h1>
  <h2>Lunes a viernes</h2>
  <h3>de 9:00 a 14:00 - 15:30 a 18:30</h3>
  <h2>Sábados</h2>
  <h3>de 9:00 a 14:00 - 15:30 a 18:30</h3>

  <h1>Días CERRADOS</h1>
  <h2>Diciembre</h2>
  <h3>6, 8, 24, 25, 26, 27 y 31</h3>
  <h2>Enero</h2>
  <h3>1, 2, 3 y 6</h3>

  <!-- Botón Google Maps -->
  <a
    id="btn-google"
    class="button"
    href="https://www.google.com/maps?q=Calle+Seúl+14,+Humanes+de+Madrid,+Madrid,+28970"
    target="_blank"
    rel="noopener noreferrer"
  >
    Abrir en Google Maps
  </a>

  <!-- Botón Apple Maps -->
  <a
    id="btn-apple"
    class="button apple"
    href="https://maps.apple.com/?address=Calle%20Se%C3%BAl,14,28970,Humanes%20de%20Madrid,Madrid,Spain"
    target="_blank"
    rel="noopener noreferrer"
  >
    Abrir en Apple Maps
  </a>

  <!-- Firebase + Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      increment
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDpY0Hqd_IU88ilrPK0da92U_mvPAcTYIg",
      authDomain: "qr-reciclame.firebaseapp.com",
      projectId: "qr-reciclame",
      storageBucket: "qr-reciclame.firebasestorage.app",
      messagingSenderId: "801108546220",
      appId: "1:801108546220:web:f8519a5596dc0ef0384509"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const countersRef = doc(db, "metrics", "counters");
    const btnGoogle = document.getElementById("btn-google");
    const btnApple = document.getElementById("btn-apple");

    function getDateKey() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, "0");
      const d = String(now.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`; // p.ej. 2025-12-05
    }

    function getHourKey() {
      const now = new Date();
      const dateKey = getDateKey();
      const h = String(now.getHours()).padStart(2, "0");
      return `${dateKey}-${h}`; // p.ej. 2025-12-05-14
    }

    async function incrementDailyAndHourly(field) {
      const dateKey = getDateKey();
      const hourKey = getHourKey();

      const dailyRef = doc(db, "daily", dateKey);
      const hourlyRef = doc(db, "hourly", hourKey);

      // Función auxiliar
      async function safeIncrement(ref, fieldName) {
        try {
          await updateDoc(ref, { [fieldName]: increment(1) });
        } catch (error) {
          if (error.code === "not-found") {
            // Si no existe el doc, lo creamos con ese campo a 1
            await setDoc(
              ref,
              { visits: 0, google: 0, apple: 0, [fieldName]: 1 },
              { merge: true }
            );
          } else {
            console.error("Error incrementando", fieldName, "en", ref.path, error);
          }
        }
      }

      await safeIncrement(dailyRef, field);
      await safeIncrement(hourlyRef, field);
    }

    async function registerEvent(type) {
      try {
        // Métrica global
        await updateDoc(countersRef, { [type]: increment(1) });
      } catch (error) {
        console.error("Error incrementando contador global", type, error);
      }

      // Métrica diaria + horaria
      try {
        await incrementDailyAndHourly(type);
      } catch (error) {
        console.error("Error incrementando métricas diarias/horarias", type, error);
      }
    }

    async function initCounters() {
      try {
        const snap = await getDoc(countersRef);

        if (!snap.exists()) {
          await setDoc(countersRef, {
            visits: 0,
            google: 0,
            apple: 0
          });
        }

        // Registrar visita (global + diario + horario)
        await registerEvent("visits");
      } catch (error) {
        console.error("Error inicializando contadores:", error);
      }
    }

    btnGoogle.addEventListener("click", () => {
      registerEvent("google");
    });

    btnApple.addEventListener("click", () => {
      registerEvent("apple");
    });

    initCounters();
  </script>

</body>
</html>
